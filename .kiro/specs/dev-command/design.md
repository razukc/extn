# Design Document

## Overview

This feature enhances the project templates generated by the extn CLI to include a fully-configured development workflow. When developers run `npm run dev` in their generated project, it automatically starts Vite's development server and launches a browser with the extension loaded using web-ext.

The design introduces a **shared base template** architecture where Browser Preview features are template-agnostic and inherited by all template types (vanilla, React, Vue, etc.). This ensures consistent development experience across all frameworks while keeping framework-specific configurations separate.

The implementation includes:
1. A new `base` template containing shared Browser Preview features
2. Template inheritance system where specific templates (vanilla, React, Vue) extend the base
3. Package.json merging to combine base dependencies/scripts with template-specific ones
4. Shared web-ext configuration and development workflow

This approach keeps the extn CLI simple (just scaffolding) while giving generated projects a powerful, self-contained development experience. The design leverages existing tools (Vite, @crxjs/vite-plugin, and web-ext) without requiring custom orchestration code in the CLI.

## Architecture

### Template Inheritance Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Base Template                             │
│  (Shared Browser Preview Features)                           │
│  - web-ext-config.mjs                                        │
│  - dev script pattern                                        │
│  - web-ext + concurrently dependencies                       │
│  - Dev workflow documentation                                │
└────────┬──────────────────────────────────┬────────────────┘
         │                                   │
         ▼                                   ▼
┌────────────────────────┐         ┌────────────────────────┐
│   Vanilla Template     │         │   React Template       │
│   - vite.config.js     │         │   - vite.config.js     │
│   - Vanilla deps       │         │   - React deps         │
│   - Basic structure    │         │   - React structure    │
└────────────────────────┘         └────────────────────────┘
                                             │
                                             ▼
                                   ┌────────────────────────┐
                                   │    Vue Template        │
                                   │   - vite.config.js     │
                                   │   - Vue deps           │
                                   │   - Vue structure      │
                                   └────────────────────────┘
```

### Runtime Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                   Generated Project                          │
│         (Base + Template-specific merged files)              │
└────────┬──────────────────────────────────┬─────────────────┘
         │                                   │
         ▼                                   ▼
┌────────────────────────┐         ┌────────────────────────┐
│    Vite Dev Server     │         │       web-ext          │
│   + @crxjs/vite-plugin │         │   (Browser Launcher)   │
│   (Build + HMR)        │         │                        │
└────────────────────────┘         └────────┬───────────────┘
                                             │
                                             ▼
                                   ┌────────────────────────┐
                                   │   Browser Instance     │
                                   │   + Temp Profile       │
                                   │   (auto-managed)       │
                                   └────────────────────────┘
```

### Component Interaction Flow

1. **Startup Sequence**
   ```
   User runs `npm run dev` in generated project
     ↓
   npm script starts two processes concurrently:
     ├─ Vite dev server (vite)
     └─ web-ext run (waits for Vite to be ready)
     ↓
   Vite builds extension to dist/
     ↓
   @crxjs/vite-plugin processes manifest and sets up HMR
     ↓
   web-ext detects dist/ is ready
     ↓
   web-ext launches browser with extension loaded
     ↓
   Browser uses temporary profile (web-ext default)
   ```

2. **Development Loop**
   ```
   Developer edits source file
     ↓
   Vite detects change
     ↓
   @crxjs/vite-plugin rebuilds affected modules
     ↓
   HMR updates extension in browser
     ↓
   (For manifest/background changes: full extension reload)
   ```

## Components and Interfaces

### 1. Base Template Structure

**Purpose:** Provide shared Browser Preview features for all template types

**New directory structure:**
```
src/templates/
├── base/                                    # NEW: Base template
│   ├── template.json                        # Base metadata
│   └── files/
│       ├── web-ext-config.mjs               # Browser config (shared)
│       ├── .gitignore.partial.template      # Empty (reserved for future)
│       └── README.partial.md.template       # Dev workflow docs (shared)
│
└── vanilla/                                 # Existing vanilla template
    ├── template.json                        # Updated to extend base
    └── files/
        ├── manifest.json.template           # Vanilla-specific
        ├── vite.config.js.template          # Vanilla-specific
        ├── package.json.template            # Vanilla-specific (merged with base)
        ├── .gitignore.template              # Vanilla-specific
        ├── README.md.template               # Vanilla-specific (merged with base partial)
        └── src/                             # Vanilla source files
            ├── popup/
            ├── options/
            └── background/
```

**Base template.json:**
```json
{
  "id": "base",
  "name": "Base Template",
  "description": "Shared Browser Preview features for all templates",
  "dependencies": [],
  "devDependencies": [
    "web-ext@^8.3.0",
    "concurrently@^9.1.0"
  ],
  "scripts": {
    "dev": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js\""
  }
}
```

**Responsibilities:**
- Define shared Browser Preview dependencies (web-ext, concurrently)
- Define shared dev script pattern
- Provide web-ext-config.js for all templates
- Serve as foundation for template inheritance

### 2. Template Inheritance System

**Purpose:** Enable templates to extend base template and merge configurations

**Updates to `src/core/template/registry.ts`:**
```typescript
export interface Template {
  id: string;
  name: string;
  description: string;
  files: string;
  dependencies: string[];
  devDependencies: string[];
  scripts?: Record<string, string>;  // NEW: npm scripts
  extends?: string;                   // NEW: base template id
}
```

**Updates to `src/core/template/engine.ts`:**
```typescript
export class TemplateEngine {
  /**
   * Merge base and template-specific package.json configurations
   */
  mergePackageJson(
    basePackage: any,
    templatePackage: any,
    context: TemplateContext
  ): any {
    return {
      ...basePackage,
      ...templatePackage,
      scripts: {
        ...basePackage.scripts,
        ...templatePackage.scripts,
      },
      dependencies: this.mergeDependencies(
        basePackage.dependencies,
        templatePackage.dependencies
      ),
      devDependencies: this.mergeDependencies(
        basePackage.devDependencies,
        templatePackage.devDependencies
      ),
    };
  }

  /**
   * Merge dependency lists, preferring template-specific versions
   */
  private mergeDependencies(
    base: Record<string, string> = {},
    template: Record<string, string> = {}
  ): Record<string, string> {
    return { ...base, ...template };
  }
}
```

**Responsibilities:**
- Load base template when specific template extends it
- Merge package.json scripts and dependencies
- Copy files from both base and specific template
- Handle conflicts (template-specific overrides base)

### 3. Vanilla Template Updates

**Purpose:** Update vanilla template to extend base template

**Changes to `src/templates/vanilla/template.json`:**
```json
{
  "id": "vanilla",
  "name": "Vanilla JavaScript",
  "description": "A basic Chrome extension template with vanilla JavaScript, Vite, and @crxjs/vite-plugin",
  "extends": "base",
  "dependencies": [],
  "devDependencies": [
    "@crxjs/vite-plugin@^2.2.1",
    "vite@^7.2.2"
  ],
  "scripts": {
    "build": "vite build",
    "preview": "vite preview"
  }
}
```

**Changes to vanilla template structure:**
- Remove web-ext-config.js (now in base)
- Keep vanilla-specific files (vite.config.js, manifest.json, etc.)
- Package.json will be merged from base + vanilla

**Responsibilities:**
- Provide vanilla JavaScript-specific configuration
- Extend base template for Browser Preview features
- Define vanilla-specific build scripts
- Maintain vanilla template file structure

### 4. Web-ext Configuration File

**Purpose:** Configure web-ext behavior for browser launching (shared across all templates)

**New file: `src/templates/base/files/web-ext-config.mjs`:**
```javascript
export default {
  // Source directory (Vite output)
  sourceDir: './dist',
  
  // Ignore patterns
  ignoreFiles: [
    'web-ext-config.mjs',
    'vite.config.js',
    'package.json',
    'package-lock.json',
    'tsconfig.json',
    'node_modules/**',
    'src/**',
    '.git/**',
  ],
  
  // Logging
  verbose: false,
  
  // Run command specific options
  run: {
    // Open chrome://extensions page on startup
    startUrl: ['chrome://extensions'],
  },
};
```

**Responsibilities:**
- Configure web-ext to use Vite's dist/ output
- Configure browser launch options (start URL)
- Exclude unnecessary files from extension loading
- Shared across all template types (vanilla, React, Vue, etc.)
- Uses temporary browser profile by default (web-ext default behavior)

### 5. Template .gitignore Updates

**Purpose:** Reserved for future shared gitignore patterns

**New file: `src/templates/base/files/.gitignore.partial.template`:**
```
(empty file - reserved for future use)
```

**Note:** This partial gitignore file is currently empty but reserved for future shared patterns. Each template (vanilla, React, Vue) maintains its own .gitignore with framework-specific patterns.

**Responsibilities:**
- Reserved for future shared gitignore patterns
- Use partial file approach to merge with template-specific ignores if needed
- Keep Browser Preview patterns separate from framework-specific patterns

### 6. Template README Updates

**Purpose:** Document the development workflow for generated projects (shared across all templates)

**New file: `src/templates/base/files/README.partial.md.template`:**
```markdown
## Development

Start the development server with hot module replacement:

\`\`\`bash
npm run dev
\`\`\`

This will:
1. Start Vite dev server with HMR
2. Build your extension to `dist/`
3. Launch Chrome with your extension loaded
4. Open DevTools automatically

Your changes will automatically reload in the browser!

### Configuration

You can customize the development experience by editing `web-ext-config.mjs`:

- Change browser target (chromium, firefox, edge)
- Modify browser launch options
- Configure start URLs

## Troubleshooting

### Browser doesn't open
- Ensure Chrome/Chromium is installed
- Check that port 5173 is not in use
- Try running `npm run build` first

### Extension doesn't load
- Check the console for build errors
- Verify manifest.json is valid
- Try restarting the dev server
```

**Note:** This partial README will be merged into template-specific README files. Each template maintains its own README with framework-specific instructions, and this partial adds the shared Browser Preview documentation.

**Responsibilities:**
- Document the npm run dev workflow for all templates
- Explain Browser Preview features
- Provide configuration guidance
- Include troubleshooting tips
- Use partial file approach to merge with template-specific READMEs

### 7. Template Creation Logic Updates

**Purpose:** Implement template inheritance and file merging when creating projects

**Changes needed in `src/core/template/registry.ts`:**

1. Load base template when a template extends it
2. Merge template metadata (dependencies, devDependencies, scripts)
3. Return combined template configuration

**Changes needed in `src/core/template/engine.ts`:**

1. Support rendering files from multiple template sources (base + specific)
2. Implement package.json merging logic
3. Implement partial file merging (.gitignore, README)
4. Handle file conflicts (template-specific overrides base)

**Template Resolution Flow:**
```
User runs: extn create my-extension --template vanilla
  ↓
Registry loads vanilla template
  ↓
Registry detects vanilla extends "base"
  ↓
Registry loads base template
  ↓
Registry merges metadata (deps, scripts)
  ↓
Engine renders files from base template
  ↓
Engine renders files from vanilla template
  ↓
Engine merges package.json (base + vanilla)
  ↓
Engine merges partial files (.gitignore, README)
  ↓
Project created with combined files
```

**Responsibilities:**
- Implement template inheritance system
- Merge package.json from base and specific templates
- Merge partial files (.gitignore, README)
- Copy files from both base and specific templates
- Handle file conflicts appropriately

## File Merging Strategy

### Package.json Merging

When a template extends base, package.json files are merged with the following rules:

1. **Scripts**: Base scripts + template scripts (template overrides on conflict)
2. **Dependencies**: Base deps + template deps (template version overrides on conflict)
3. **DevDependencies**: Base devDeps + template devDeps (template version overrides on conflict)
4. **Other fields**: Template values take precedence

**Example:**

Base package.json:
```json
{
  "scripts": {
    "dev": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js\""
  },
  "devDependencies": {
    "web-ext": "^8.3.0",
    "concurrently": "^9.1.0"
  }
}
```

Vanilla package.json:
```json
{
  "scripts": {
    "build": "vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "@crxjs/vite-plugin": "^2.2.1",
    "vite": "^7.2.2"
  }
}
```

Merged result:
```json
{
  "scripts": {
    "dev": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js\"",
    "build": "vite build",
    "preview": "vite preview"
  },
  "devDependencies": {
    "web-ext": "^8.3.0",
    "concurrently": "^9.1.0",
    "@crxjs/vite-plugin": "^2.2.1",
    "vite": "^7.2.2"
  }
}
```

### Partial File Merging

Files with `.partial` in their name are merged with template-specific files:

1. **README.md**: Template README + base partial appended
2. **.gitignore**: Template .gitignore + base partial appended (if base partial has content)

**Example:**

Vanilla README.md:
```markdown
# my-extension

A Chrome extension built with Vite.

## Getting Started

\`\`\`bash
npm install
\`\`\`
```

Base README.partial.md:
```markdown
## Development

Start the development server:

\`\`\`bash
npm run dev
\`\`\`

This will launch Chrome with your extension loaded.
```

Merged README.md:
```markdown
# my-extension

A Chrome extension built with Vite.

## Getting Started

\`\`\`bash
npm install
\`\`\`

## Development

Start the development server:

\`\`\`bash
npm run dev
\`\`\`

This will launch Chrome with your extension loaded.
```

### File Override Rules

When both base and template have the same file:

1. **Non-partial files**: Template file completely overrides base file
2. **Partial files**: Files are merged (see above)
3. **package.json**: Special merging logic (see above)

This ensures template-specific customizations always take precedence while preserving shared functionality.

## Data Models

### Web-ext Configuration Model

```javascript
// web-ext-config.mjs in generated projects
export default {
  sourceDir: string,           // Extension source directory
  ignoreFiles: string[],       // Files to exclude from extension
  verbose: boolean,            // Logging level
  run: {
    startUrl: string[],        // URLs to open on launch
    // Optional: chromiumProfile, firefoxProfile for persistent profiles
    // Optional: args for browser CLI arguments
  }
};
```

### Package.json Scripts Model

```json
{
  "scripts": {
    "dev": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js\"",
    "build": "vite build",
    "preview": "vite preview"
  }
}
```

## Error Handling

### Error Handling Strategy

Since the development workflow runs in the generated project using standard tools (Vite, web-ext, concurrently), error handling is provided by those tools:

1. **Browser Not Found**
   - web-ext will display error if browser binary not found
   - README includes troubleshooting section with installation links
   - Users can modify `web-ext-config.js` to specify custom browser path

2. **Port Already in Use**
   - Vite will automatically try next available port
   - Vite displays clear error message if all ports exhausted
   - Users can configure port in `vite.config.js`

3. **Build Errors**
   - Vite displays detailed error output with file and line number
   - @crxjs/vite-plugin provides extension-specific error messages
   - Dev server keeps running for retry after fixing errors

4. **Extension Load Errors**
   - web-ext validates manifest and displays errors
   - @crxjs/vite-plugin validates manifest during build
   - Chrome DevTools shows runtime errors in console

5. **Browser Launch Errors**
   - web-ext handles browser detection and launching
   - Users can specify custom browser path in web-ext-config.mjs
   - README includes troubleshooting steps

### Error Documentation

The template README includes a troubleshooting section covering:
- Browser installation and detection
- Port conflicts
- Build failures
- Extension loading issues
- Common configuration mistakes

## Testing Strategy

### Unit Tests

1. **Template File Tests**
   - Verify web-ext-config.mjs is valid JavaScript
   - Verify package.json.template has correct dependencies
   - Verify README.template includes dev workflow documentation

2. **Template Generation Tests**
   - Test that `extn create` includes all new template files
   - Verify web-ext-config.mjs is copied correctly
   - Verify package.json has correct scripts and dependencies

### Integration Tests

1. **End-to-End Project Creation and Dev Workflow**
   - Run `extn create test-project`
   - Verify all template files are present
   - Run `npm install` in generated project
   - Verify web-ext and concurrently are installed
   - Run `npm run build` to verify Vite works
   - (Manual) Run `npm run dev` to verify browser launches

2. **Template Validation**
   - Create project from template
   - Verify package.json is valid JSON
   - Verify web-ext-config.js is valid JavaScript
   - Verify all dependencies can be installed
   - Verify scripts can be executed

### Manual Testing Checklist

**Template Inheritance:**
- [ ] Base template loads correctly
- [ ] Vanilla template extends base successfully
- [ ] Package.json merges base + vanilla dependencies
- [ ] Package.json merges base + vanilla scripts
- [ ] Partial files merge correctly (.gitignore, README)

**Project Creation:**
- [ ] Run `extn create test-project` successfully
- [ ] Generated project includes web-ext-config.mjs (from base)
- [ ] Generated package.json has web-ext and concurrently (from base)
- [ ] Generated package.json has vite and @crxjs/vite-plugin (from vanilla)
- [ ] Generated README documents dev workflow (from base partial)

**Development Workflow:**
- [ ] Run `npm install` in generated project
- [ ] Run `npm run dev` starts Vite and web-ext
- [ ] Browser opens with extension loaded
- [ ] Extension appears in chrome://extensions
- [ ] DevTools open automatically
- [ ] File changes trigger HMR
- [ ] Manifest changes trigger full reload
- [ ] Ctrl+C shuts down both processes cleanly

**Cross-Platform:**
- [ ] Works on Windows
- [ ] Works on macOS
- [ ] Works on Linux

**Future Templates:**
- [ ] React template can extend base (when created)
- [ ] Vue template can extend base (when created)

## Implementation Phases

### Phase 1: Base Template Structure (Day 1)
- Create base template directory structure
- Create base template.json with shared dependencies
- Create web-ext-config.js in base template
- Create partial files (.gitignore, README) in base template

### Phase 2: Template Inheritance System (Day 2)
- Update Template interface to support extends and scripts
- Implement base template loading in registry
- Implement metadata merging in registry
- Implement package.json merging in engine
- Implement partial file merging in engine

### Phase 3: Vanilla Template Updates (Day 3)
- Update vanilla template.json to extend base
- Remove web-ext-config.mjs from vanilla (now in base)
- Update vanilla README to include dev workflow section

### Phase 4: Testing (Day 4)
- Write unit tests for template inheritance
- Write unit tests for package.json merging
- Write unit tests for partial file merging
- Write integration tests for project creation with base template
- Test generated project workflow manually
- Verify on Windows, macOS, Linux

### Phase 5: Documentation (Day 5)
- Update main extn CLI README
- Document template inheritance system
- Add dev workflow examples
- Create troubleshooting guide
- Update CHANGELOG

## Dependencies

### No New Dependencies for extn CLI

The extn CLI itself requires no new dependencies. All changes are to the template files.

### New Dependencies in Generated Projects

Generated projects will include these additional dependencies in their package.json:

```json
{
  "devDependencies": {
    "@crxjs/vite-plugin": "^2.2.1",  // Already present
    "vite": "^7.2.2",                 // Already present
    "web-ext": "^8.3.0",              // NEW
    "concurrently": "^9.1.0"          // NEW
  }
}
```

### Tool Integration

The design leverages existing tools without custom code:

**Vite** (already in templates):
- Dev server with HMR
- Build pipeline
- Configuration via vite.config.js

**@crxjs/vite-plugin** (already in templates):
- Extension-specific HMR
- Manifest processing
- Service worker handling
- Content script injection

**web-ext** (NEW):
- Browser launching
- Profile management
- Extension loading
- DevTools automation

**concurrently** (NEW):
- Run Vite and web-ext simultaneously
- Handle process lifecycle
- Aggregate console output

## Configuration

### Generated Project Usage

```bash
# In a generated project directory
cd my-extension

# Install dependencies
npm install

# Start development
npm run dev

# Build for production
npm run build
```

### Customizing Development Workflow

Users can customize the development experience by editing files in their generated project:

**web-ext-config.mjs** - Browser and launch configuration:
```javascript
export default {
  sourceDir: './dist',
  run: {
    startUrl: ['chrome://extensions', 'https://example.com'],
    // Optional: Add persistent profile
    // chromiumProfile: './.dev-profile/chrome',
    // keepProfileChanges: true,
  },
  // ... other options
};
```

**vite.config.js** - Build and dev server configuration:
```javascript
export default {
  server: {
    port: 5173,
    host: 'localhost'
  },
  // ... other Vite options
};
```

**package.json** - Script customization:
```json
{
  "scripts": {
    "dev": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js\"",
    "dev:firefox": "concurrently \"vite\" \"web-ext run --source-dir=./dist --target=firefox\"",
    "dev:verbose": "concurrently \"vite\" \"web-ext run --source-dir=./dist --config=./web-ext-config.js --verbose\""
  }
}
```

## Security Considerations

1. **Profile Isolation**
   - Temporary profiles are separate from user's main profile
   - No access to user's personal data
   - Profiles are automatically cleaned up by web-ext

2. **Extension Permissions**
   - Extension runs with declared permissions only
   - No additional privileges granted
   - Standard Chrome security model applies

3. **Network Security**
   - Vite dev server binds to localhost by default
   - CORS headers configured by @crxjs/vite-plugin
   - No external network access required

## Performance Considerations

1. **Startup Time**
   - Target: < 10 seconds from command to ready
   - Parallel initialization where possible
   - Cache browser binary detection

2. **HMR Performance**
   - Leverages Vite's optimized HMR
   - @crxjs handles extension-specific updates
   - Minimal overhead from our code

3. **Resource Management**
   - Temporary profiles are automatically cleaned up
   - No manual cleanup required
   - Minimal disk space usage

## Benefits of Template Inheritance Architecture

1. **Consistency Across Templates**
   - All templates (vanilla, React, Vue) get Browser Preview features automatically
   - Shared configuration ensures consistent development experience
   - Updates to Browser Preview features apply to all templates

2. **Maintainability**
   - Browser Preview features maintained in one place (base template)
   - No duplication of web-ext-config.js across templates
   - Easier to update and fix issues

3. **Extensibility**
   - New templates automatically inherit Browser Preview features
   - Easy to add new shared features in the future
   - Template-specific customizations remain isolated

4. **Separation of Concerns**
   - Base template handles Browser Preview (framework-agnostic)
   - Specific templates handle framework configuration (React, Vue, etc.)
   - Clear boundaries between shared and specific features

## Future Enhancements

1. **Additional Templates**
   - Create React template extending base (automatic Browser Preview)
   - Create Vue template extending base (automatic Browser Preview)
   - Create TypeScript template extending base (automatic Browser Preview)

2. **Multi-Browser Scripts**
   - Add `dev:firefox` script to base template
   - Add `dev:edge` script to base template
   - Add `dev:all` script to launch multiple browsers

3. **Advanced Base Features**
   - Add example web-ext-config.js variations to base
   - Document advanced browser launch options
   - Provide configuration presets in base

4. **Development Tools (Base Template)**
   - Add debugging helpers
   - Add extension reload utilities
   - Add build verification scripts

5. **Enhanced Inheritance**
   - Support multiple inheritance levels (base → framework → variant)
   - Add template composition (mix multiple base templates)
   - Support conditional file inclusion based on template options

6. **Documentation**
   - Create video tutorial for dev workflow
   - Add troubleshooting flowchart
   - Document template inheritance system
   - Document common customizations
